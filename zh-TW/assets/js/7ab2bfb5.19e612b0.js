"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1532],{9613:(e,n,o)=>{o.d(n,{Zo:()=>p,kt:()=>f});var t=o(9496);function r(e,n,o){return n in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e}function a(e,n){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),o.push.apply(o,t)}return o}function i(e){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?a(Object(o),!0).forEach((function(n){r(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function l(e,n){if(null==e)return{};var o,t,r=function(e,n){if(null==e)return{};var o,t,r={},a=Object.keys(e);for(t=0;t<a.length;t++)o=a[t],n.indexOf(o)>=0||(r[o]=e[o]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)o=a[t],n.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var s=t.createContext({}),d=function(e){var n=t.useContext(s),o=n;return e&&(o="function"==typeof e?e(n):i(i({},n),e)),o},p=function(e){var n=d(e.components);return t.createElement(s.Provider,{value:n},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},c=t.forwardRef((function(e,n){var o=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=d(o),c=r,f=m["".concat(s,".").concat(c)]||m[c]||u[c]||a;return o?t.createElement(f,i(i({ref:n},p),{},{components:o})):t.createElement(f,i({ref:n},p))}));function f(e,n){var o=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=c;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[m]="string"==typeof e?e:r,i[1]=l;for(var d=2;d<a;d++)i[d]=o[d];return t.createElement.apply(null,i)}return t.createElement.apply(null,o)}c.displayName="MDXCreateElement"},7651:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>f,frontMatter:()=>l,metadata:()=>d,toc:()=>m});var t=o(1966),r=o(9836),a=(o(9496),o(9613)),i=["components"],l={id:"symlinked-node-modules-structure",title:"\u57fa\u65bc\u7b26\u865f\u9023\u63a5\u7684 node_modules \u7d50\u69cb"},s=void 0,d={unversionedId:"symlinked-node-modules-structure",id:"version-7.x/symlinked-node-modules-structure",title:"\u57fa\u65bc\u7b26\u865f\u9023\u63a5\u7684 node_modules \u7d50\u69cb",description:"\u672c\u6587\u7ae0\u53ea\u6703\u4ecb\u7d39\u5728\u6c92\u6709\u5957\u4ef6\u6709 peer \u4f9d\u8cf4\u7684\u60c5\u6cc1\u4e0b pnpm \u7684 node_modules \u662f\u5982\u4f55\u88ab\u69cb\u5efa\u7684\u3002 \u5c0d\u65bc\u6709 peer \u4f9d\u8cf4\u7684\u66f4\u8907\u96dc\u7684\u5834\u666f\uff0c\u8acb\u770bpeer \u662f\u5982\u4f55\u88ab\u89e3\u6790\u7684\u3002",source:"@site/i18n/zh-TW/docusaurus-plugin-content-docs/version-7.x/symlinked-node-modules-structure.md",sourceDirName:".",slug:"/symlinked-node-modules-structure",permalink:"/zh-TW/7.x/symlinked-node-modules-structure",draft:!1,editUrl:"https://translate.pnpm.io/project/pnpm/zh-TW",tags:[],version:"7.x",frontMatter:{id:"symlinked-node-modules-structure",title:"\u57fa\u65bc\u7b26\u865f\u9023\u63a5\u7684 node_modules \u7d50\u69cb"},sidebar:"version-7.x/docs",previous:{title:"Limitations",permalink:"/zh-TW/7.x/limitations"},next:{title:"peer \u662f\u5982\u4f55\u88ab\u89e3\u6790\u7684",permalink:"/zh-TW/7.x/how-peers-are-resolved"}},p={},m=[],u={toc:m},c="wrapper";function f(e){var n=e.components,o=(0,r.Z)(e,i);return(0,a.kt)(c,(0,t.Z)({},u,o,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u672c\u6587\u7ae0\u53ea\u6703\u4ecb\u7d39\u5728\u6c92\u6709\u5957\u4ef6\u6709 peer \u4f9d\u8cf4\u7684\u60c5\u6cc1\u4e0b pnpm \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," \u662f\u5982\u4f55\u88ab\u69cb\u5efa\u7684\u3002 \u5c0d\u65bc\u6709 peer \u4f9d\u8cf4\u7684\u66f4\u8907\u96dc\u7684\u5834\u666f\uff0c\u8acb\u770b",(0,a.kt)("a",{parentName:"p",href:"/zh-TW/7.x/how-peers-are-resolved"},"peer \u662f\u5982\u4f55\u88ab\u89e3\u6790\u7684"),"\u3002")),(0,a.kt)("p",null,"pnpm \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," \u7d50\u69cb\u4f7f\u7528\u7b26\u865f\u9023\u63a5\u4f86\u5275\u5efa\u4f9d\u8cf4\u9805\u7684\u5d4c\u5957\u7d50\u69cb\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," \u4e2d\u6bcf\u500b\u5957\u4ef6\u7684\u6bcf\u500b\u6587\u4ef6\u90fd\u662f\u4f86\u81ea\u5167\u5bb9\u53ef\u5c0b\u5740\u5b58\u5132\u7684\u786c\u9023\u63a5\u3002 \u5047\u8a2d\u60a8\u5b89\u88dd\u4e86\u4f9d\u8cf4\u65bc ",(0,a.kt)("inlineCode",{parentName:"p"},"bar@1.0.0")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"foo@1.0.0"),"\u3002 pnpm \u6703\u5c07\u5169\u500b\u5305\u786c\u9023\u63a5\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules"),"\uff0c\u5982\u4e0b\u6240\u793a\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"node_modules\n\u2514\u2500\u2500 .pnpm\n    \u251c\u2500\u2500 bar@1.0.0\n    \u2502   \u2514\u2500\u2500 node_modules\n    \u2502       \u2514\u2500\u2500 bar -> <store>/bar\n    \u2502           \u251c\u2500\u2500 index.js\n    \u2502           \u2514\u2500\u2500 package.json\n    \u2514\u2500\u2500 foo@1.0.0\n        \u2514\u2500\u2500 node_modules\n            \u2514\u2500\u2500 foo -> <store>/foo\n                \u251c\u2500\u2500 index.js\n                \u2514\u2500\u2500 package.json\n")),(0,a.kt)("p",null,"\u9019\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," \u4e2d\u7684\u552f\u4e00\u7684\u201c\u771f\u5be6\u201d\u6587\u4ef6\u3002 \u4e00\u65e6\u6240\u6709\u5957\u4ef6\u90fd\u786c\u9023\u63a5\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules"),"\uff0c\u5c31\u6703\u5275\u5efa\u7b26\u865f\u9023\u63a5\u4f86\u69cb\u5efa\u5d4c\u5957\u7684\u4f9d\u8cf4\u95dc\u4fc2\u5716\u7d50\u69cb\u3002"),(0,a.kt)("p",null,"As you might have noticed, both packages are hard linked into a subfolder inside a ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," folder (",(0,a.kt)("inlineCode",{parentName:"p"},"foo@1.0.0/node_modules/foo"),"). This is needed to:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"allow packages to import themselves.")," ",(0,a.kt)("inlineCode",{parentName:"li"},"foo")," should be able to ",(0,a.kt)("inlineCode",{parentName:"li"},"require('foo/package.json')")," or ",(0,a.kt)("inlineCode",{parentName:"li"},'import * as package from "foo/package.json"'),"."),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"avoid circular symlinks.")," Dependencies of packages are placed in the same folder in which the dependent packages are. For Node.js it doesn't make a difference whether dependencies are inside the package's ",(0,a.kt)("inlineCode",{parentName:"li"},"node_modules")," or in any other ",(0,a.kt)("inlineCode",{parentName:"li"},"node_modules")," in the parent directories.")),(0,a.kt)("p",null,"The next stage of installation is symlinking dependencies. ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," is going to be symlinked to the ",(0,a.kt)("inlineCode",{parentName:"p"},"foo@1.0.0/node_modules")," folder:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"node_modules\n\u2514\u2500\u2500 .pnpm\n    \u251c\u2500\u2500 bar@1.0.0\n    \u2502   \u2514\u2500\u2500 node_modules\n    \u2502       \u2514\u2500\u2500 bar -> <store>/bar\n    \u2514\u2500\u2500 foo@1.0.0\n        \u2514\u2500\u2500 node_modules\n            \u251c\u2500\u2500 foo -> <store>/foo\n            \u2514\u2500\u2500 bar -> ../../bar@1.0.0/node_modules/bar\n")),(0,a.kt)("p",null,"Next, direct dependencies are handled. ",(0,a.kt)("inlineCode",{parentName:"p"},"foo")," is going to be symlinked into the root ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules")," folder because ",(0,a.kt)("inlineCode",{parentName:"p"},"foo")," is a dependency of the project:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"node_modules\n\u251c\u2500\u2500 foo -> ./.pnpm/foo@1.0.0/node_modules/foo\n\u2514\u2500\u2500 .pnpm\n    \u251c\u2500\u2500 bar@1.0.0\n    \u2502   \u2514\u2500\u2500 node_modules\n    \u2502       \u2514\u2500\u2500 bar -> <store>/bar\n    \u2514\u2500\u2500 foo@1.0.0\n        \u2514\u2500\u2500 node_modules\n            \u251c\u2500\u2500 foo -> <store>/foo\n            \u2514\u2500\u2500 bar -> ../../bar@1.0.0/node_modules/bar\n")),(0,a.kt)("p",null,"This is a very simple example. However, the layout will maintain this structure regardless of the number of dependencies and the depth of the dependency graph."),(0,a.kt)("p",null,"Let's add ",(0,a.kt)("inlineCode",{parentName:"p"},"qar@2.0.0")," as a dependency of ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"foo"),". This is how the new structure will look:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"node_modules\n\u251c\u2500\u2500 foo -> ./.pnpm/foo@1.0.0/node_modules/foo\n\u2514\u2500\u2500 .pnpm\n    \u251c\u2500\u2500 bar@1.0.0\n    \u2502   \u2514\u2500\u2500 node_modules\n    \u2502       \u251c\u2500\u2500 bar -> <store>/bar\n    \u2502       \u2514\u2500\u2500 qar -> ../../qar@2.0.0/node_modules/qar\n    \u251c\u2500\u2500 foo@1.0.0\n    \u2502   \u2514\u2500\u2500 node_modules\n    \u2502       \u251c\u2500\u2500 foo -> <store>/foo\n    \u2502       \u251c\u2500\u2500 bar -> ../../bar@1.0.0/node_modules/bar\n    \u2502       \u2514\u2500\u2500 qar -> ../../qar@2.0.0/node_modules/qar\n    \u2514\u2500\u2500 qar@2.0.0\n        \u2514\u2500\u2500 node_modules\n            \u2514\u2500\u2500 qar -> <store>/qar\n")),(0,a.kt)("p",null,"As you may see, even though the graph is deeper now (",(0,a.kt)("inlineCode",{parentName:"p"},"foo > bar > qar"),"), the directory depth in the file system is still the same."),(0,a.kt)("p",null,"This layout might look weird at first glance, but it is completely compatible with Node's module resolution algorithm! When resolving modules, Node ignores symlinks, so when ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," is required from ",(0,a.kt)("inlineCode",{parentName:"p"},"foo@1.0.0/node_modules/foo/index.js"),", Node does not use ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," at ",(0,a.kt)("inlineCode",{parentName:"p"},"foo@1.0.0/node_modules/bar"),", but instead, ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," is resolved to its real location (",(0,a.kt)("inlineCode",{parentName:"p"},"bar@1.0.0/node_modules/bar"),"). As a consequence, ",(0,a.kt)("inlineCode",{parentName:"p"},"bar")," can also resolve its dependencies which are in ",(0,a.kt)("inlineCode",{parentName:"p"},"bar@1.0.0/node_modules"),"."),(0,a.kt)("p",null,"A great bonus of this layout is that only packages that are really in the dependencies are accessible. With a flattened ",(0,a.kt)("inlineCode",{parentName:"p"},"node_modules"),' structure, all hoisted packages are accessible. To read more about why this is an advantage, see "',(0,a.kt)("a",{parentName:"p",href:"https://www.kochan.io/nodejs/pnpms-strictness-helps-to-avoid-silly-bugs.html"},"pnpm's strictness helps to avoid silly bugs"),'"'))}f.isMDXComponent=!0}}]);