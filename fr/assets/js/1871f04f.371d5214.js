"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[848],{9613:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>f});var r=t(9496);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=r.createContext({}),s=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},u=function(e){var n=s(e.components);return r.createElement(i.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=s(t),m=o,f=c["".concat(i,".").concat(m)]||c[m]||d[m]||a;return t?r.createElement(f,p(p({ref:n},u),{},{components:t})):r.createElement(f,p({ref:n},u))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,p=new Array(a);p[0]=m;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l[c]="string"==typeof e?e:o,p[1]=l;for(var s=2;s<a;s++)p[s]=t[s];return r.createElement.apply(null,p)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},4168:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>i,default:()=>f,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var r=t(1966),o=t(9836),a=(t(9496),t(9613)),p=["components"],l={id:"fetch",title:"pnpm fetch"},i=void 0,s={unversionedId:"cli/fetch",id:"cli/fetch",title:"pnpm fetch",description:"R\xe9cup\xe8re les paquets d'un fichier de verrouillage dans le magasin virtuel, le manifeste des paquets est ignor\xe9.",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/cli/fetch.md",sourceDirName:"cli",slug:"/cli/fetch",permalink:"/fr/next/cli/fetch",draft:!1,editUrl:"https://translate.pnpm.io/project/pnpm/fr",tags:[],version:"current",frontMatter:{id:"fetch",title:"pnpm fetch"},sidebar:"docs",previous:{title:"pnpm prune",permalink:"/fr/next/cli/prune"},next:{title:"pnpm install-test",permalink:"/fr/next/cli/install-test"}},u={},c=[{value:"Sc\xe9nario d&#39;utilisation",id:"sc\xe9nario-dutilisation",level:2},{value:"Options",id:"options",level:2},{value:"--dev, -D",id:"--dev--d",level:3},{value:"--prod, -P",id:"--prod--p",level:3}],d={toc:c},m="wrapper";function f(e){var n=e.components,t=(0,o.Z)(e,p);return(0,a.kt)(m,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"R\xe9cup\xe8re les paquets d'un fichier de verrouillage dans le magasin virtuel, le manifeste des paquets est ignor\xe9."),(0,a.kt)("h2",{id:"sc\xe9nario-dutilisation"},"Sc\xe9nario d'utilisation"),(0,a.kt)("p",null,"Cette commande est sp\xe9cifiquement con\xe7ue pour am\xe9liorer la construction d'une image Docker."),(0,a.kt)("p",null,"Vous avez peut-\xeatre lu le ",(0,a.kt)("a",{parentName:"p",href:"https://nodejs.org/en/docs/guides/nodejs-docker-webapp/"},"guide officiel")," pour \xe9crire un Dockerfile pour une application Node.js, si vous ne l'avez pas encore lu, vous pouvez le lire en premier."),(0,a.kt)("p",null,"\xc0 partir de ce guide, nous apprenons \xe0 \xe9crire un Dockerfile optimis\xe9 pour les projets utilisant pnpm, qui ressemble \xe0"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'FROM node:14\n\nWORKDIR /chemin/vers/quelque part\n\nRUN curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm\n\n# Fichiers requis par pnpm install\nCOPY .npmrc package.json pnpm-lock.yaml .pnpmfile.cjs ./\n\n# Si vous avez corrig\xe9 un paquet, incluez \xe9galement les correctifs avant l\'installation\nCOPY patches patches\n\nRUN pnpm install --frozen-lockfile --prod\n\n# Bundle app source\nCOPY . .\n\nEXPOSE 8080\nCMD [ "node", "server.js" ]\n')),(0,a.kt)("p",null,"Tant qu'il n'y a pas de changement \xe0 ",(0,a.kt)("inlineCode",{parentName:"p"},".npmrc"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"paquet. son"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"pnpm-lock.yaml"),", ",(0,a.kt)("inlineCode",{parentName:"p"},".pnpmfile. js"),", le cache de construction de docker est toujours valide jusqu'\xe0 la couche de ",(0,a.kt)("inlineCode",{parentName:"p"},"RUN pnpm install --frozen-lockfile --prod"),", qui co\xfbtent la plupart du temps lors de la construction d'une image de docker."),(0,a.kt)("p",null,"Cependant, la modification du ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json")," peut se produire beaucoup plus fr\xe9quemment que nous nous attendions, car il ne contient pas seulement des d\xe9pendances, mais peut \xe9galement contenir le num\xe9ro de version, des scripts et une configuration arbitraire pour tout autre outil."),(0,a.kt)("p",null,"Il est \xe9galement difficile de maintenir un Dockerfile qui construit un projet monorepo, il peut ressembler"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'FROM node:14\n\nWORKDIR /chemin/vers/quelque part\n\nRUN curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm\n\n# Fichiers requis par pnpm install\nCOPY .npmrc package.json pnpm-lock.yaml .pnpmfile.cjs ./\n\n# Si vous avez corrig\xe9 un paquet, incluez \xe9galement les correctifs avant l\'installation\nCOPY patches patches\n\n# pour chaque sous-paquet, nous devons ajouter une \xe9tape suppl\xe9mentaire pour copier \n# son manifeste au bon endroit, car docker n\'a aucun moyen de filtrer uniquement \n# le package.json avec une seule instruction\nCOPY packages/foo/backage.json packages/foo/\nCOPY packages/bar/backage.json packages/bar/\n\nRUN pnpm install --frozen-lockfile --prod\n\n# Bundle app source\nCOPY . .\n\nEXPOSE 8080\nCMD [ "node", "server.js" ]\n\n')),(0,a.kt)("p",null,"Comme vous pouvez le constater, le Dockerfile doit \xeatre mis \xe0 jour lorsque vous ajoutez ou supprimez des sous-paquets."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"pnpm fetch")," r\xe9sout parfaitement le probl\xe8me en offrant la possibilit\xe9 de r\xe9cup\xe9rer des modules dans le stockage virtuel en utilisant uniquement les informations d'un fichier verrouill\xe9."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'FROM node:14\n\nWORKDIR /chemin/vers/quelque part\n\nRUN curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm\n\n# pnpm fetch n\'a besoin que du lockfile\nCOPY pnpm-lock.yaml ./\n\n# Si vous avez apport\xe9 des correctifs \xe0 un paquet, incluez les correctifs avant de lancer pnpm fetch\nCOPY patches patches\n\nRUN pnpm fetch --prod\n\n\nADD . ./\nRUN pnpm install -r --offline --prod\n\n\nEXPOSE 8080\nCMD [ "node", "server.js" ]\n')),(0,a.kt)("p",null,"Cela fonctionne pour les projets simples, ainsi que les monorepo, ",(0,a.kt)("inlineCode",{parentName:"p"},"--offline")," force pnpm \xe0 ne pas communiquer avec le registre de module car tous les modules n\xe9cessaires sont d\xe9j\xe0 pr\xe9sents dans le stockage virtuel."),(0,a.kt)("p",null,"Tant que le fichier verrouill\xe9 n'est pas chang\xe9, le cache de compilation est valide, donc ",(0,a.kt)("inlineCode",{parentName:"p"},"RUN pnpm install -r --offline --prod"),", va vous faire gagnez \xe9norm\xe9ment de temps."),(0,a.kt)("h2",{id:"options"},"Options"),(0,a.kt)("h3",{id:"--dev--d"},"--dev, -D"),(0,a.kt)("p",null,"Seuls les paquets de d\xe9veloppement seront r\xe9cup\xe9r\xe9s"),(0,a.kt)("h3",{id:"--prod--p"},"--prod, -P"),(0,a.kt)("p",null,"Les paquets de d\xe9veloppement ne seront pas r\xe9cup\xe9r\xe9s"))}f.isMDXComponent=!0}}]);